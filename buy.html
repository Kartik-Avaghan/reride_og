<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buy</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="./css/nav.css" />
    <link rel="stylesheet" href="./css/buy.css" />
    <link rel="stylesheet" href="./css/footer.css" />
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="d-flex justify-content-between align-items-start">
        <!-- Logo -->
        <a href="index.html" class="logo">
          <img src="./images/home/Reride_Logo.png" alt="Reride Logo" />
        </a>

        <!-- Right side: Hamburger + Nav -->
        <div class="d-flex flex-column align-items-end">
          <!-- Hamburger -->
          <button class="hamburger d-lg-none ms-3" id="hamburger">
            &#9776;
          </button>

          <!-- Navigation -->
          <nav class="nav" id="navMenu">
            <ul class="nav__list">
              <!-- Search -->
              <li class="nav-item">
                <div class="search-container">
                  <input
                    type="text"
                    placeholder="Search"
                    class="nav-search-input"
                    id="indexSearch"
                  />
                  <button class="search-btn" onclick="indexSearch()">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="#fff"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                    >
                      <path
                        d="M10,2A8,8 0 1,0 18,10A8,8 0 0,0 10,2M22,22L17,17"
                        stroke="white"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>
              </li>
              <!-- Links -->
              <li class="nav-item">
                <a href="./index.html" class="nav-link">Home</a>
              </li>
              <li class="nav-item">
                <a href="./aboutUs.html" class="nav-link">About Us</a>
              </li>
              <li class="nav-item">
                <a href="./buy.html" class="nav-link active">Buy</a>
              </li>
              <li class="nav-item">
                <a href="./sell.html" class="nav-link">Sell</a>
              </li>
              <li class="nav-item">
                <a href="./contact.html" class="nav-link">Contact</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <div
      class="slide_1"
      style="margin-bottom: 5%; padding-top: 2%; background-color: #faf2f0"
    >
      <div class="main_3 w-100 clearfix">
        <section id="booking">
          <div class="container-xl">
            <div
              class="booking_m clearfix"
              style="background-color: #faf2f0; padding-bottom: 2%"
            >
              <div class="row booking_1">
                <div class="col-md-12">
                  <h4 class="mb-0">Book Your Vehicle</h4>
                </div>
              </div>
              <div class="row booking_2 mt-4">
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-map-marker me-1 col_oran"></i>Select
                      Location
                    </h6>
                    <select class="form-select" id="select-location">
                      <option value="">Select Location</option>
                    </select>
                    <script>
                      // Fetch locations when page loads
                      fetch("http://localhost:8080/branch/website/getBranches")
                      .then(response => response.json())
                      .then(data => {
                        const select = document.getElementById('select-location');
                        data.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.branchId;
                        option.textContent = branch.branchArea;
                        select.appendChild(option);
                        });
                      })
                      .catch(error => {
                        console.error('Error fetching locations:', error);
                        const select = document.getElementById('select-location');
                        select.innerHTML = '<option>Error loading locations</option>';
                      });
                    </script>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-car me-1 col_oran"></i>Select Vehicle
                      Brand
                    </h6>
                    <select class="form-select" id="select-brand">
                      <option>Select Vehicle Brand</option>
                      <option>Bajaj</option>
                      <option>Hero</option>
                      <option>Jawa</option>
                      <option>Honda</option>
                      <option>Mahindra</option>
                      <option>Suzuki</option>
                      <option>TVS</option>
                      <option>Vespa</option>
                      <option>OLA</option>
                      <option>Yamaha</option>
                      <option>Royal Enfield</option>
                    </select>
                  </div>
                </div>
                
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-car me-1 col_oran"></i>Search Type
                    </h6>
                    <select class="form-select" id="select-type">
                      <option>Seach Type</option>
                      <option>BIKE</option>
                      <option>SCOOTER</option>
                    </select>
                  </div>
                </div>

                <!-- <div class="col-md-3 col-sm-6 mb-3">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-map-marker me-1 col_oran"></i>Model Name
                    </h6>
                    <select class="form-select" id="select-model" disabled>
                      <option value="">Select Model</option>
                    </select>
                  </div>
                </div> -->

              </div>
              <div class="row booking_2 mt-4">
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-money me-1 col_oran"></i>Price
                    </h6>
                    <div class="booking_2i1 row">
                      <div class="col-md-8">
                        <div class="booking_2i1l">
                          <input
                            class="form-control"
                            id="price"
                            type="text"
                            name="price"
                            placeholder="ex: less than 50000rs"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-calendar me-1 col_oran"></i>Model Year
                    </h6>
                    <div class="booking_2i1 row">
                      <div class="col-md-8">
                        <div class="booking_2i1l">
                          <input
                            class="form-control"
                            id="modelYear"
                            type="number"
                            placeholder="ex: 2020 and after"
                            min="1900"
                            max="2100"
                            name="modeYear"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-calendar me-1 col_oran"></i>Mileage
                    </h6>
                    <div class="booking_2i1 row">
                      <div class="col-md-8">
                        <div class="booking_2i1l">
                          <input
                            class="form-control"
                            id="mileage"
                            type="text"
                            name="mileage"
                            placeholder="ex: 20kmpl and greater"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-12">
                  <div class="booking_2i">
                    <h6 class="mb-3">
                      <i class="fa fa-search me-1 col_oran"></i> Find
                    </h6>
                    <h6 class="text-center mb-0">
                      <a
                        class="button d-block btn"
                        style="background-color: #0a1f58; color: white"
                        href="#"
                        onclick="searchVehicle()"
                        >Search</a
                      >
                    </h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <div class="container" id="cards-wrapper">
      
      <a
        class="button d-block btn"
        style="
          background-color: #0a1f58;
          color: white;
          width: 10%;
          display: flex;
          justify-self: flex-end;
          margin-bottom: 1%;
        "
        href="./buy.html"
        >Clear</a>

      <div id="results" class="row g-3"></div>

    </div>

    <div
      id="incoming-search-display"
      style="margin: 1em 0; font-weight: bold"
    ></div>

    <!-- Footer -->
    <footer>
      <p>&copy; 2025 <strong style="color: #0a1f58">ReRide</strong>.</p>
    </footer>
  </body>
  <script src="./js/buy/buy.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"
  ></script>
  <script src="./js/nav.js"></script>

  <!-- <script>
    let vehiclesData = [];

    // Fetch vehicles
    fetch("http://localhost:8080/vehicle/website/getVehicles")
      .then((r) => {
        if (!r.ok) throw new Error("Failed to load vehicles");
        return r.json();
      })
      .then((d) => {
        console.log(d);
        vehiclesData = Array.isArray(d) ? d : [];
        renderVehicles(vehiclesData);
      })
      .catch((err) => {
        console.error(err);
        const container = document.getElementById("results");
        if (container)
          container.innerHTML =
            '<div class="col-12 text-center text-danger">Unable to load vehicles.</div>';
      });

    // Build one vehicle card
    function buildCard(v) {
      const {
        vehicleId,
        vehicleModel,
        vehicleType,
        vehicleBrand,
        vehicleOutLetPrice,
        vehicleRegisterNumber,
        vehicleModelYear,
        vehicleMileage,
        vehicleOwnerType,
        vehicleImage,
      } = v;

      const imgArray =
        typeof vehicleImage === "string"
          ? JSON.parse(vehicleImage)
          : vehicleImage;
      const imgSrc =
        imgArray && imgArray.length
          ? `http://localhost:8080/uploads/${imgArray[0]}`
          : "./images/no-image.png";

      return `
      <div class="col-12 col-sm-6 col-md-3">
        <div class="vehicle-card card shadow-sm border-0 overflow-hidden h-100">
          <div class="vehicle-image position-relative">
            <img src="${imgSrc}" alt="${vehicleModel}" class="card-img-top img-fluid" />
            <div class="assured-badge">Re-Ride Assured</div>
          </div>

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 class="card-title fw-semibold mb-1">${vehicleBrand} ${vehicleModel}</h5>
                <p class="mb-1 text-muted small"> ${vehicleType}</p>
              </div>
              <div class="text-end">
                <h4 class=" mb-0 price">&#8377;${vehicleOutLetPrice}</h4>
              </div>
            </div>

            <hr class="my-2" />

            <div class="row gy-1">
              <div class="col-6">
                
                <p class="mb-0 text-muted small"><i class="fa fa-calendar text-primary me-1"></i> ${vehicleModelYear}</p>
              </div>
              <div class="col-6 text-end">
                <p class="mb-1"><i class="fa fa-tachometer text-primary me-1"></i> Milage: ${vehicleMileage} km/l</p>
                <p class="mb-0 text-muted small text-nowrap"><i class="fa fa-user text-primary me-1"></i> Owner: ${vehicleOwnerType}</p>
              </div>
            </div>
          </div>

          <div class="card-footer bg-white border-0 text-center">
            <small class="text-muted d-block mb-2 fw-bold">Reg No: ${vehicleRegisterNumber}</small>
            <a href="/bikeDetails.html?id=${vehicleId}" class="px-4 py-2 shadow-sm book-btn btn btn-outline-primary">
              <i class="fa fa-check-circle me-1"></i> Book Ride
            </a>
          </div>
        </div>
      </div>
    `;
    }

    // Render all vehicles
    function renderVehicles(data) {
      const container = document.getElementById("results");
      if (!container) return;

      if (!data || data.length === 0) {
        container.innerHTML =
          '<div class="col-12 text-center text-muted">No vehicles available.</div>';
        return;
      }

      container.innerHTML = data.map((v) => buildCard(v)).join("");
    }
  </script> -->

  <script>
    /* ---------- CONFIG ---------- */
    const API_BASE = "http://localhost:8080/vehicle/website";

    /* ---------- STATE ---------- */
    let vehiclesData = [];

    /* ---------- BUILD CARD ---------- */
    function buildCard(v) {
      const {
        vehicleId,
        vehicleModel,
        vehicleType,
        vehicleBrand,
        vehicleOutLetPrice,
        vehicleRegisterNumber,
        vehicleModelYear,
        vehicleMileage,
        vehicleOwnerType,
        vehicleImage,
      } = v || {};

      const imgArray = JSON.parse(vehicleImage);
      const imgSrc =
        imgArray && imgArray.length
          ? `http://localhost:8080/uploads/${imgArray[0]}`
          : "./images/no-image.png";

      const priceText =
        vehicleOutLetPrice === null ||
        vehicleOutLetPrice === undefined ||
        String(vehicleOutLetPrice).trim() === ""
          ? "Price on request"
          : `‚Çπ${vehicleOutLetPrice}`;

      return `
        <div class="col-12 col-sm-6 col-md-3">
          <div class="vehicle-card card shadow-sm border-0 overflow-hidden h-100">
            <div class="vehicle-image position-relative">
              <img src="${imgSrc}" alt="${
            vehicleModel ?? "Vehicle"
          }" class="card-img-top img-fluid" />
              <div class="assured-badge">Re-Ride Assured</div>
            </div>

            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="card-title fw-semibold mb-1">${vehicleBrand ?? ""} ${
            vehicleModel ?? ""
          }</h5>
                  <p class="mb-1 text-muted small">${vehicleType ?? ""}</p>
                </div>
                <div class="text-end">
                  <h4 class="mb-0 price">${priceText}</h4>
                </div>
              </div>

              <hr class="my-2" />

              <div class="row gy-1">
                <div class="col-6">
                  <p class="mb-0 text-muted small"><i class="fa fa-calendar text-primary me-1"></i> ${
                    vehicleModelYear ?? "N/A"
                  }</p>
                </div>
                <div class="col-6 text-end">
                  <p class="mb-1"><i class="fa fa-tachometer text-primary me-1"></i> Milage: ${
                    vehicleMileage ?? "N/A"
                  }</p>
                  <p class="mb-0 text-muted small text-nowrap"><i class="fa fa-user text-primary me-1"></i> Owner: ${
                    vehicleOwnerType ?? "N/A"
                  }</p>
                </div>
              </div>
            </div>

            <div class="card-footer bg-white border-0 text-center">
              <small class="text-muted d-block mb-2 fw-bold">Reg No: ${
                vehicleRegisterNumber ?? "N/A"
              }</small>
              <a href="/bikeDetails.html?id=${
                vehicleId ?? ""
              }" class="px-4 py-2 shadow-sm book-btn btn btn-outline-primary">
                <i class="fa fa-check-circle me-1"></i> Book Ride
              </a>
            </div>
          </div>
        </div>
      `;
    }

    /* ---------- RENDER ---------- */
    function renderVehicles(data) {
      const container = document.getElementById("results");
      if (!container) return;

      if (!data || data.length === 0) {
        container.innerHTML =
          '<div class="col-12 text-center text-muted">No vehicles available.</div>';
        return;
      }

      container.innerHTML = data.map((v) => buildCard(v)).join("");
    }

    /* ---------- FILTER SUMMARY ---------- */
    function showFiltersSummary(paramsObj) {
      const el = document.getElementById("incoming-search-display");
      if (!el) return;
      const parts = [];
      if (paramsObj.vehicleInspectionBranch)
        parts.push(`Location: ${paramsObj.vehicleInspectionBranch}`);
      if (paramsObj.vehicleBrand)
        parts.push(`Brand: ${paramsObj.vehicleBrand}`);
      if (paramsObj.vehicleModel)
        parts.push(`Model: ${paramsObj.vehicleModel}`);
      if (paramsObj.vehicleType) parts.push(`Type: ${paramsObj.vehicleType}`);
      if (paramsObj.vehicleModelYear)
        parts.push(`Year: ${paramsObj.vehicleModelYear}`);
      if (paramsObj.vehicleMileage)
        parts.push(`Mileage: ${paramsObj.vehicleMileage}`);
      if (paramsObj.vehicleOutLetPrice)
        parts.push(`Price: ${paramsObj.vehicleOutLetPrice}`);
      el.textContent = parts.length ? `Filters ‚Äî ${parts.join(" ‚Ä¢ ")}` : "";
    }

    // Converts object to query string, skipping undefined/empty values
      function qsEncode(obj) {
        const params = Object.entries(obj)
          .filter(([_, val]) => val !== undefined && val !== null && String(val).trim() !== "")
          .map(
            ([key, val]) =>
              `${encodeURIComponent(key)}=${encodeURIComponent(String(val).trim())}`
          );
        return params.length ? "?" + params.join("&") : "";
      }

      // Reads all filters and keeps only real, user-entered values
      function getFilterValues() {
        const raw = {
          vehicleInspectionBranch: document.getElementById("select-location")?.value || "",
          vehicleBrand: document.getElementById("select-brand")?.value || "",
          vehicleModel: document.getElementById("select-model")?.value || "",
          vehicleType: document.getElementById("select-type")?.value || "",
          vehicleModelYear: document.getElementById("modelYear")?.value || "",
          vehicleMileage: document.getElementById("mileage")?.value || "",
          vehicleOutLetPrice: document.getElementById("price")?.value || "",
        };

        const cleaned = {};
        for (const [key, val] of Object.entries(raw)) {
          const trimmed = String(val).trim().toLowerCase();

          // üö´ ignore placeholders and defaults
          const isPlaceholder =
            trimmed === "" ||
            trimmed.startsWith("select") ||
            trimmed.includes("search") ||
            trimmed.includes("seach"); // handles misspelled ‚ÄúSeach Type‚Äù

          if (!isPlaceholder) {
            cleaned[key] = val.trim(); // keep original casing for backend
          }
        }

        return cleaned;
      }


    /* ---------- SEARCH ---------- */
    async function searchVehicle() {
      const container = document.getElementById("results");
      if (!container) return;

      const paramsObj = getFilterValues();
      // showFiltersSummary(paramsObj);

      // show loader
      container.innerHTML =
        '<div class="col-12 text-center py-5">Searching‚Ä¶</div>';

      try {
        // const query = paramsObj;
        const query = qsEncode(paramsObj);
        const url = `${API_BASE}/getVehicles/search${query}`;
        const res = await fetch(url, {
          method: "GET",
          headers: {
            Accept: "application/json",
          },
        });

        if (!res.ok) {
          throw new Error(`Server returned ${res.status}`);
        }

        const data = await res.json();
        // Backend returns List<VehicleDTO>; ensure it's array
        const arr = Array.isArray(data) ? data : data?.vehicles ?? [];
        vehiclesData = arr;
        renderVehicles(vehiclesData);
      } catch (err) {
        console.error("Search error:", err);
        container.innerHTML =
          '<div class="col-12 text-center text-danger">Unable to fetch search results. Try again later.</div>';
      }
    }

    /* ---------- INITIAL LOAD (all vehicles) ---------- */
    async function loadAllVehicles() {
      const container = document.getElementById("results");
      if (!container) return;

      container.innerHTML =
        '<div class="col-12 text-center py-5">Loading‚Ä¶</div>';
      try {
        const res = await fetch(`${API_BASE}/getVehicles`);
        if (!res.ok) throw new Error("Failed to load vehicles");
        const data = await res.json();
        // If your GET returns { vehicles: [...] } or an array directly:
        const arr = Array.isArray(data)
          ? data
          : Array.isArray(data.vehicles)
          ? data.vehicles
          : [];
        vehiclesData = arr;
        renderVehicles(vehiclesData);
      } catch (e) {
        console.error(e);
        container.innerHTML =
          '<div class="col-12 text-center text-danger">Unable to load vehicles.</div>';
      }
    }

    /* ---------- Hook search button to Enter key on inputs (optional convenience) ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      // allow Enter to trigger search on filter inputs
      const inputs = [
        "select-location",
        "select-brand",
        "select-type",
        "select-model",
        "modelYear",
        "mileage",
        "price",
      ]
        .map((id) => document.getElementById(id))
        .filter(Boolean);

      inputs.forEach((el) =>
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            searchVehicle();
          }
        })
      );

      // initial load
      loadAllVehicles();
    });
  </script>
</html>
